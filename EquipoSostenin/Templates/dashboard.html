{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Panel - Sostenin</title>
    <link rel="stylesheet" href="{% static 'boleta/dashboard.css' %}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>

    <div class="container">

        <div class="header">
            <h2 class="panel_control">Panel de Control de {{ nombre_usuario }}</h2>
            <a class= "subir_boleta" href="{% url 'subir_boleta' %}" >+ Subir Nueva Boleta</a>
        </div>
        
        <hr>

        {% if boletas_luz_existen %}
            <div class="chart-container">
                <h3>Historial de Consumo - Luz (Chilquinta)</h3>
                <canvas id="graficoLuz"></canvas>
            </div>
        {% endif %}

        {% if boletas_agua_existen %}
            <div class="chart-container">
                <h3>Historial de Consumo - Agua (Esval)</h3>
                <canvas id="graficoAgua"></canvas>
            </div>
        {% endif %}

        <h3 style="margin-top: 40px;">Mis Boletas Procesadas</h3>
        {% if boletas_ok %}
        <table>
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Fecha Emisión</th>
                    <th>Consumo</th>
                    <th>Monto Total ($)</th>
                    
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for boleta in boletas_ok %}
                <tr class="success">
                    <td>{{ boleta.get_servicio_display }}</td>
                    <td>{{ boleta.fecha_emision }}</td>
                    <td>{{ boleta.consumo|floatformat:0 }} 
                        {% if boleta.servicio == 'Luz' %}kWh{% else %}m³{% endif %}
                    </td>
                    <td>{{ boleta.monto }}</td>
                    
                    <td>
                        <form 
                            method="POST" 
                            action="{% url 'delete_boleta' boleta.id %}"
                            onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta boleta?');">
                            
                            {% csrf_token %}
                            <button type="submit" class="btn-delete">Borrar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {% endif %}

        
        {% if boletas_error %}
            <h3 style="margin-top: 40px;">Boletas con Error de Procesamiento</h3>
            <table>
                <thead>
                    <tr>
                        <th>Fecha de Subida</th>
                        <th>Servicio</th>
                        <th>Archivo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for boleta in boletas_error %}
                    <tr class="error">
                        <td>{{ boleta.fecha_registro }}</td>
                        <td>{{ boleta.get_servicio_display }}</td>
                        <td>{{ boleta.archivo_boleta.name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <script>
        
        // --- INICIO: Gráfico de LUZ ---
        const canvasLuz = document.getElementById('graficoLuz');
        if (canvasLuz) {
            
            // --- INICIO DE LA CORRECCIÓN ---
            // Quitamos JSON.parse(). Los datos de Django ya son un array JS.
            const labelsLuz = {{ chart_luz_labels|safe }};
            const dataMontoLuz = {{ chart_luz_data_monto|safe }};
            const dataConsumoLuz = {{ chart_luz_data_consumo|safe }};
            // --- FIN DE LA CORRECCIÓN ---

            new Chart(canvasLuz, {
                type: 'line', 
                data: {
                    labels: labelsLuz,
                    datasets: [
                        {
                            label: 'Monto Total ($)',
                            data: dataMontoLuz,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            yAxisID: 'yMonto',
                        },
                        {
                            label: 'Consumo (kWh)',
                            data: dataConsumoLuz,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            yAxisID: 'yConsumo',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'MMM yyyy'
                            },
                            title: { display: true, text: 'Fecha de Emisión' }
                        },
                        yMonto: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Monto Total ($)' }
                        },
                        yConsumo: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Consumo (kWh)' },
                            grid: { drawOnChartArea: false } 
                        }
                    }
                }
            });
        }
        
        // --- INICIO: Gráfico de AGUA ---
        const canvasAgua = document.getElementById('graficoAgua');
        if (canvasAgua) {
            
            // --- INICIO DE LA CORRECCIÓN ---
            const labelsAgua = {{ chart_agua_labels|safe }};
            const dataMontoAgua = {{ chart_agua_data_monto|safe }};
            const dataConsumoAgua = {{ chart_agua_data_consumo|safe }};
            // --- FIN DE LA CORRECCIÓN ---

            new Chart(canvasAgua, {
                type: 'line',
                data: {
                    labels: labelsAgua,
                    datasets: [
                        {
                            label: 'Monto Total ($)',
                            data: dataMontoAgua,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            yAxisID: 'yMonto',
                        },
                        {
                            label: 'Consumo (m³)',
                            data: dataConsumoAgua,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            yAxisID: 'yConsumo',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'MMM yyyy'
                            },
                            title: { display: true, text: 'Fecha de Emisión' }
                        },
                        yMonto: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Monto Total ($)' }
                        },
                        yConsumo: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Consumo (m³)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
    </script>

</body>
</html>