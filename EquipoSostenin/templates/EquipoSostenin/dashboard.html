{% extends "base.html" %}

{% block title %}Mi Panel{% endblock %}

{% block body_class %}body-full-width bg-f3{% endblock %}

{% block head_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}


{% block content %}
<div class="dashboard-container">

    <div class="dashboard-header">
        <h2>Panel de Control de {{ nombre_usuario }}</h2>
        <a class="boton-subir" href="{% url 'subir_boleta' %}" >+ Subir Nueva Boleta</a>
    </div>
    
    <hr>

    {% if boletas_ok %}
        {% if boletas_luz_existen %}
            <div class="chart-container">
                <h3>Historial de Consumo - Luz</h3>
                <canvas id="graficoLuz"></canvas>
            </div>
        {% endif %}
        {% if boletas_agua_existen %}
            <div class="chart-container">
                <h3>Historial de Consumo - Agua</h3>
                <canvas id="graficoAgua"></canvas>
            </div>
        {% endif %}

        {% if huella %}
        <h2 style="margin-top: 40px; color: #333;">Tu Huella de Consumo (Ãšltimo Mes)</h2>
        <div class="huella-container">
            
            {% if huella.luz %}
            <div class="huella-card">
                <h3>ðŸ’¡ Electricidad</h3>
                
                <div class="huella-ranking {{ huella.luz.css_class }}">
                    {{ huella.luz.ranking }}
                </div>

                <div class="huella-stat">
                    <span class="huella-stat-label">Tu Consumo:</span> 
                    {{ huella.luz.ultimo_consumo|floatformat:0 }} kWh
                </div>
                <div class="huella-stat">
                    <span class="huella-stat-label">Promedio Nacional:</span>
                    {{ huella.luz.promedio_nacional|floatformat:0 }} kWh
                </div>
                <div class="huella-stat">
                    <span class="huella-stat-label">Huella vs Nacional:</span>
                    {% if huella.luz.huella_nacional_pct > 0 %}
                        <span class="huella-valor-positivo">+{{ huella.luz.huella_nacional_pct|floatformat:0 }}%</span>
                        (sobre el promedio)
                    {% else %}
                        <span class="huella-valor-negativo">{{ huella.luz.huella_nacional_pct|floatformat:0 }}%</span>
                        (bajo el promedio)
                    {% endif %}
                </div>
                
                <div class="huella-tip">
                    {{ huella.luz.tip }}
                </div>

                <hr style="margin-top: 20px;">
                <div class="huella-stat" style="font-size: 0.9em; color: #777;">
                    <span class="huella-stat-label">Promedio App:</span>
                    {{ huella.luz.promedio_app|floatformat:0 }} kWh
                </div>
            </div>
            {% endif %}
            {% if huella.agua %}
            <div class="huella-card">
                <h3>ðŸ’§ Agua</h3>

                <div class="huella-ranking {{ huella.agua.css_class }}">
                    {{ huella.agua.ranking }}
                </div>

                <div class="huella-stat">
                    <span class="huella-stat-label">Tu Consumo:</span> 
                    {{ huella.agua.ultimo_consumo|floatformat:2 }} mÂ³
                </div>
                <div class="huella-stat">
                    <span class="huella-stat-label">Promedio Nacional:</span>
                    {{ huella.agua.promedio_nacional|floatformat:1 }} mÂ³
                </div>
                <div class="huella-stat">
                    <span class="huella-stat-label">Huella vs Nacional:</span>
                    {% if huella.agua.huella_nacional_pct > 0 %}
                        <span class="huella-valor-positivo">
                            +{{ huella.agua.huella_nacional_pct|floatformat:0 }}%
                        </span>
                        (sobre el promedio)
                    {% else %}
                        <span class="huella-valor-negativo">
                            {{ huella.agua.huella_nacional_pct|floatformat:0 }}%
                        </span>
                        (bajo el promedio)
                    {% endif %}
                </div>
                
                <div class="huella-tip">
                    {{ huella.agua.tip }}
                </div>
                
                <hr style="margin-top: 20px;">
                <div class="huella-stat" style="font-size: 0.9em; color: #777;">
                    <span class="huella-stat-label">Promedio App:</span>
                    {{ huella.agua.promedio_app|floatformat:2 }} mÂ³
                </div>
            </div>
            {% endif %}
            </div>
    {% endif %}
        
        <h3 style="margin-top: 40px; color: #333;">Mis Boletas Procesadas</h3>
        <table class="tabla-boletas">
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Fecha EmisiÃ³n</th>
                    <th>Consumo</th>
                    <th>Monto Total ($)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for boleta in boletas_ok %}
                <tr class="success">
                    <td>{{ boleta.get_servicio_display }}</td>
                    <td>{{ boleta.fecha_emision }}</td>
                    
                    {% if boleta.servicio == 'Luz' %}
                        <td>{{ boleta.consumo|floatformat:0 }} kWh</td>
                    {% else %}
                        <td>{{ boleta.consumo|floatformat:2 }} mÂ³</td>
                    {% endif %}
                    
                    <td>{{ boleta.monto }}</td>
                    <td>
                        <form 
                            method="POST" 
                            action="{% url 'delete_boleta' boleta.id %}"
                            onsubmit="return confirm('Â¿EstÃ¡s seguro de que quieres eliminar esta boleta?');">
                            {% csrf_token %}
                            <button type="submit" class="btn-delete">Borrar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    {% else %}
        <div class="huella-card" style="margin-top: 30px; text-align: center;">
            <h3 style="font-size: 1.5em; color: #679a45;">Â¡Bienvenido, {{ nombre_usuario }}!</h3>
            <p style="font-size: 1.1em; color: #555; line-height: 1.6;">
                Este es tu panel de control. Por ahora estÃ¡ vacÃ­o porque 
                aÃºn no has subido ninguna boleta.
                <br><br>
                Sube tu primer PDF para que podamos generar tus grÃ¡ficos y 
                calcular tu primera "Huella de Consumo".
            </p>
            
            <a href="{% url 'subir_boleta' %}" class="boton" 
               style="max-width: 300px; margin: 20px auto 0 auto; background-color: #f9b347; color: #679a45;">
                + Subir mi primera boleta
            </a>
        </div>

    {% endif %}
    
    {% if boletas_error %}
        <h3 style="margin-top: 40px; color: #333;">Boletas con Error de Procesamiento</h3>
        <table class="tabla-boletas-error">
            <thead>
                <tr>
                    <th>Fecha de Subida</th>
                    <th>Servicio</th>
                    <th>Archivo</th>
                </tr>
            </thead>
            <tbody>
                {% for boleta in boletas_error %}
                <tr class="error">
                    <td>{{ boleta.fecha_registro }}</td>
                    <td>{{ boleta.get_servicio_display }}</td>
                    <td>{{ boleta.archivo_boleta.name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

</div> <script>
    // ... (Tu cÃ³digo de Chart.js para canvasLuz) ...
    const canvasLuz = document.getElementById('graficoLuz');
    if (canvasLuz) {
        const labelsLuz = {{ chart_luz_labels|safe }};
        const dataMontoLuz = {{ chart_luz_data_monto|safe }};
        const dataConsumoLuz = {{ chart_luz_data_consumo|safe }};
        new Chart(canvasLuz, {
            type: 'line', 
            data: {
                labels: labelsLuz,
                datasets: [
                    {
                        label: 'Monto Total ($)',
                        data: dataMontoLuz,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'yMonto',
                    },
                    {
                        label: 'Consumo (kWh)',
                        data: dataConsumoLuz,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        yAxisID: 'yConsumo',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month', tooltipFormat: 'MMM yyyy' },
                        title: { display: true, text: 'Fecha de EmisiÃ³n' }
                    },
                    yMonto: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Monto Total ($)' }
                    },
                    yConsumo: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Consumo (kWh)' },
                        grid: { drawOnChartArea: false } 
                    }
                }
            }
        });
    }
    
    // ... (Tu cÃ³digo de Chart.js para canvasAgua) ...
    const canvasAgua = document.getElementById('graficoAgua');
    if (canvasAgua) {
        const labelsAgua = {{ chart_agua_labels|safe }};
        const dataMontoAgua = {{ chart_agua_data_monto|safe }};
        const dataConsumoAgua = {{ chart_agua_data_consumo|safe }};
        new Chart(canvasAgua, {
            type: 'line',
            data: {
                labels: labelsAgua,
                datasets: [
                    {
                        label: 'Monto Total ($)',
                        data: dataMontoAgua,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        yAxisID: 'yMonto',
                    },
                    {
                        label: 'Consumo (mÂ³)',
                        data: dataConsumoAgua,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        yAxisID: 'yConsumo',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month', tooltipFormat: 'MMM yyyy' },
                        title: { display: true, text: 'Fecha de EmisiÃ³n' }
                    },
                    yMonto: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Monto Total ($)' }
                    },
                    yConsumo: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Consumo (mÂ³)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }
</script>

{% endblock %}